
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../step-05/">
      
      
        <link rel="next" href="../step-07/">
      
      
      <link rel="icon" href="../images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.34">
    
    
      
        <title>Step 6 - Deconstructing the RAG - Quarkus LangChain4j Workshop</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#step-06-deconstructing-the-rag-pattern" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
You are not viewing the latest version.
<a href="../..">
    <strong>Click here to go to latest.</strong>
</a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Quarkus LangChain4j Workshop" class="md-header__button md-logo" aria-label="Quarkus LangChain4j Workshop" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Quarkus LangChain4j Workshop
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Step 6 - Deconstructing the RAG
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H6zm7-4.68V17c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-2.26C3.19 13.47 2 11.38 2 9c0-3.87 3.13-7 7-7 1.65 0 3.16.57 4.35 1.5C10.8 4.57 9 7.07 9 10c0 2.79 1.64 5.19 4 6.32m7.92-6.38-1.42-.91-1.4.97.4-1.65-1.33-1.03 1.68-.11.56-1.61.63 1.58 1.68.04-1.3 1.08zM19.39 13c-1.89 2.27-5.36 2.19-7.17-.05C10 10.13 11.56 6 15 5.34c.34-.05.64.29.5.63-.45 1.28-.38 2.74.35 4a4.62 4.62 0 0 0 3.27 2.28c.35.05.5.49.27.75"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 6a6 6 0 0 1 6 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-1.8c-1.79-1.04-3-2.98-3-5.2a6 6 0 0 1 6-6m2 15v1a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1zm6-10h3v2h-3zM1 11h3v2H1zM13 1v3h-2V1zM4.92 3.5l2.13 2.14-1.42 1.41L3.5 4.93zm12.03 2.13 2.12-2.13 1.43 1.43-2.13 2.12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/quarkusio/quarkus-langchain4j-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Quarkus LangChain4j Workshop" class="md-nav__button md-logo" aria-label="Quarkus LangChain4j Workshop" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    Quarkus LangChain4j Workshop
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/quarkusio/quarkus-langchain4j-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../requirements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Requirements
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 1 - Introduction to Quarkus LangChain4j
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-02/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 2 - Playing with model parameters
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-03/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 3 - Streaming responses
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-04/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 4 - Using system messages
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-05/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 5 - Introduction to the RAG pattern
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Step 6 - Deconstructing the RAG
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Step 6 - Deconstructing the RAG
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#a-bit-of-cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      A bit of cleanup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#embedding-model" class="md-nav__link">
    <span class="md-ellipsis">
      Embedding model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vector-store" class="md-nav__link">
    <span class="md-ellipsis">
      Vector store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ingesting-documents-into-the-vector-store" class="md-nav__link">
    <span class="md-ellipsis">
      Ingesting documents into the vector store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-retriever-and-augmentor" class="md-nav__link">
    <span class="md-ellipsis">
      The retriever and augmentor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-the-application" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the application
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-rag" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced RAG
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-07/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 7 - Function calling and tools
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-08/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 8 - Guardrails
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../conclusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conclusion
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#a-bit-of-cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      A bit of cleanup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#embedding-model" class="md-nav__link">
    <span class="md-ellipsis">
      Embedding model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vector-store" class="md-nav__link">
    <span class="md-ellipsis">
      Vector store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ingesting-documents-into-the-vector-store" class="md-nav__link">
    <span class="md-ellipsis">
      Ingesting documents into the vector store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-retriever-and-augmentor" class="md-nav__link">
    <span class="md-ellipsis">
      The retriever and augmentor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-the-application" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the application
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-rag" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced RAG
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<div><h1 id="step-06-deconstructing-the-rag-pattern">Step 06 - Deconstructing the RAG pattern<a class="headerlink" href="#step-06-deconstructing-the-rag-pattern" title="Permanent link"></a></h1>
<p>In the previous step, we implemented a RAG (Retrieval Augmented Generation) pattern in our AI service using <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/easy-rag.html" target="_blank">EasyRag</a>.
Most of the complexity was hidden by EasyRag.</p>
<p>In this step, we will deconstruct the RAG pattern to understand how it works under the hood.
We will see how we can customize it and use our own knowledge base and embedding model.</p>
<p>If you want to see the final result of this step, you can check out the <code>step-06</code> directory.
Otherwise, let’s get started!</p>
<h2 id="a-bit-of-cleanup">A bit of cleanup<a class="headerlink" href="#a-bit-of-cleanup" title="Permanent link"></a></h2>
<p>Let’s start with a bit of cleanup.
<mark>First, open the <code>src/main/resources/application.properties</code> file and remove the following configuration:</mark></p>
<div class="highlight"><span class="filename">application.properties</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="na">quarkus.langchain4j.easy-rag.path</span><span class="o">=</span><span class="s">src/main/resources/rag</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="na">quarkus.langchain4j.easy-rag.max-segment-size</span><span class="o">=</span><span class="s">100</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="na">quarkus.langchain4j.easy-rag.max-overlap-size</span><span class="o">=</span><span class="s">25</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="na">quarkus.langchain4j.easy-rag.max-results</span><span class="o">=</span><span class="s">3</span>
</code></pre></div>
<p><mark>Then, open the <code>pom.xml</code> file and remove the following dependency:</mark></p>
<div class="highlight"><span class="filename">pom.xml</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>io.quarkiverse.langchain4j<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>quarkus-langchain4j-easy-rag<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="nt">&lt;version&gt;</span>${quarkus-langchain4j.version}<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You could also open another terminal and run</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>./mvnw<span class="w"> </span>quarkus:remove-extension<span class="w"> </span>-Dextension<span class="o">=</span>easy-rag
</code></pre></div>
</div>
<h2 id="embedding-model">Embedding model<a class="headerlink" href="#embedding-model" title="Permanent link"></a></h2>
<p>One of the core components of the RAG pattern is the embedding model.
The embedding model is used to transform the text into numerical vectors.
These vectors are used to compare the text and find the most relevant segments.</p>
<p>Selecting a good embedding model is crucial.
In the previous step, we used the default embedding model provided by OpenAI.
You can however use your own embedding model as well.</p>
<p>In this step, we will use the <a href="https://huggingface.co/neuralmagic/bge-small-en-v1.5-quant" target="_blank">bge-small-en-q</a> embedding model.</p>
<p><mark>Add the following dependency to your <code>pom.xml</code> file:</mark></p>
<div class="highlight"><span class="filename">pom.xml</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>dev.langchain4j<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>langchain4j-embeddings-bge-small-en-q<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="nt">&lt;version&gt;</span>0.35.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You could also open another terminal and run</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>./mvnw<span class="w"> </span>quarkus:add-extension<span class="w"> </span>-Dextension<span class="o">=</span>dev.langchain4j:langchain4j-embeddings-bge-small-en-q:0.35.0
</code></pre></div>
</div>
<p>This dependency provides the <code>bge-small-en-q</code> embedding model.
It will run locally, on your machine.
Thus, you do not have to send your document to a remote service to compute the embeddings.</p>
<p>This embedding model generates vectors of size 384.
It’s a small model, but it’s enough for our use case.</p>
<p>To use the model, we will use the <a href="https://github.com/langchain4j/langchain4j-embeddings/blob/main/langchain4j-embeddings-bge-small-en-q/src/main/java/dev/langchain4j/model/embedding/onnx/bgesmallenq/BgeSmallEnQuantizedEmbeddingModel.java" target="_blank"><code>dev.langchain4j.model.embedding.onnx.bgesmallenq.BgeSmallEnQuantizedEmbeddingModel</code></a> CDI bean automatically created by Quarkus by adding the following to <code>src/main/resources/application.properties</code>:</p>
<div class="highlight"><span class="filename">application.properties</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="na">quarkus.langchain4j.embedding-model.provider</span><span class="o">=</span><span class="s">dev.langchain4j.model.embedding.onnx.bgesmallenq.BgeSmallEnQuantizedEmbeddingModel</span>
</code></pre></div>
<h2 id="vector-store">Vector store<a class="headerlink" href="#vector-store" title="Permanent link"></a></h2>
<p>Now that we have our embedding model, we need to store the embeddings.
In the previous step, we used an <em>in memory</em> store.
Now we will use a persistent store to keep the embeddings between restarts.</p>
<p>There are many options to store the embeddings, like <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/redis-store.html" target="_blank">Redis</a>, <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/infinispan-store.html" target="_blank">Infinispan</a>, specialized databases (like <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/chroma-store.html" target="_blank">Chroma</a>), etc.
Here, we will use the <a href="https://docs.quarkiverse.io/quarkus-langchain4j/dev/pgvector-store.html" target="_blank">PostgreSQL pgVector store</a>, a popular relational database.</p>
<p><mark>Add the following dependency to your <code>pom.xml</code> file:</mark></p>
<div class="highlight"><span class="filename">pom.xml</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>io.quarkiverse.langchain4j<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>quarkus-langchain4j-pgvector<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="nt">&lt;version&gt;</span>${quarkus-langchain4j.version}<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You could also open another terminal and run</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>./mvnw<span class="w"> </span>quarkus:add-extension<span class="w"> </span>-Dextension<span class="o">=</span>langchain4j-pgvector
</code></pre></div>
</div>
<p>This embedding store (like many others) needs to know the size of the embeddings that will be stored in advance.
<mark>Open the <code>src/main/resources/application.properties</code> file and add the following configuration:</mark></p>
<div class="highlight"><span class="filename">application.properties</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="na">quarkus.langchain4j.pgvector.dimension</span><span class="o">=</span><span class="s">384</span>
</code></pre></div>
<p>The value is the size of the vectors generated by the <code>bge-small-en-q</code> embedding model.</p>
<p>Now we will be able to use the <code>io.quarkiverse.langchain4j.pgvector.PgVectorEmbeddingStore</code> bean to store and retrieve the embeddings.</p>
<h2 id="ingesting-documents-into-the-vector-store">Ingesting documents into the vector store<a class="headerlink" href="#ingesting-documents-into-the-vector-store" title="Permanent link"></a></h2>
<p><mark>While you are editing the <code>src/main/resources/application.properties</code> file, add the following configuration:</mark></p>
<div class="highlight"><span class="filename">application.properties</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="na">rag.location</span><span class="o">=</span><span class="s">src/main/resources/rag</span>
</code></pre></div>
<p>This is a custom config property that we will use to specify the location of the documents that will be ingested into the vector store.
It replaces the <code>quarkus.langchain4j.easy-rag.path</code> property from the previous step.</p>
<p>Now let’s create our <em>ingestor</em>.
Remember that the role of the <em>ingestor</em> is to read the documents and store their embeddings in the vector store.</p>
<p><img alt="The ingestion process" src="../images/ingestion.png"></p>
<p><mark>Create the <code>dev.langchain4j.quarkus.workshop.RagIngestion</code> class with the following content:</mark></p>
<div class="highlight"><span class="filename">RagIngestion.java</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">dev.langchain4j.quarkus.workshop</span><span class="p">;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kn">import static</span><span class="w"> </span><span class="nn">dev.langchain4j.data.document.splitter.DocumentSplitters.recursive</span><span class="p">;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.file.Path</span><span class="p">;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.event.Observes</span><span class="p">;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.config.inject.ConfigProperty</span><span class="p">;</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkus.logging.Log</span><span class="p">;</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkus.runtime.StartupEvent</span><span class="p">;</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.data.document.Document</span><span class="p">;</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.data.document.loader.FileSystemDocumentLoader</span><span class="p">;</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.model.embedding.EmbeddingModel</span><span class="p">;</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.store.embedding.EmbeddingStore</span><span class="p">;</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.store.embedding.EmbeddingStoreIngestor</span><span class="p">;</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RagIngestion</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="cm">     * Ingests the documents from the given location into the embedding store.</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="cm">     *</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="cm">     * @param ev             the startup event to trigger the ingestion when the application starts</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="cm">     * @param store          the embedding store the embedding store (PostGreSQL in our case)</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="cm">     * @param embeddingModel the embedding model to use for the embedding (BGE-Small-EN-Quantized in our case)</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="cm">     * @param documents      the location of the documents to ingest</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="cm">     */</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ingest</span><span class="p">(</span><span class="nd">@Observes</span><span class="w"> </span><span class="n">StartupEvent</span><span class="w"> </span><span class="n">ev</span><span class="p">,</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="w">                       </span><span class="n">EmbeddingStore</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">EmbeddingModel</span><span class="w"> </span><span class="n">embeddingModel</span><span class="p">,</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a><span class="w">                       </span><span class="nd">@ConfigProperty</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"rag.location"</span><span class="p">)</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="n">documents</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a><span class="w">        </span><span class="n">store</span><span class="p">.</span><span class="na">removeAll</span><span class="p">();</span><span class="w"> </span><span class="c1">// cleanup the store to start fresh (just for demo purposes)</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Document</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FileSystemDocumentLoader</span><span class="p">.</span><span class="na">loadDocumentsRecursively</span><span class="p">(</span><span class="n">documents</span><span class="p">);</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a><span class="w">        </span><span class="n">EmbeddingStoreIngestor</span><span class="w"> </span><span class="n">ingestor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EmbeddingStoreIngestor</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a><span class="w">                </span><span class="p">.</span><span class="na">embeddingStore</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a><span class="w">                </span><span class="p">.</span><span class="na">embeddingModel</span><span class="p">(</span><span class="n">embeddingModel</span><span class="p">)</span>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a><span class="w">                </span><span class="p">.</span><span class="na">documentSplitter</span><span class="p">(</span><span class="n">recursive</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">))</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a><span class="w">        </span><span class="n">ingestor</span><span class="p">.</span><span class="na">ingest</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"Documents ingested successfully"</span><span class="p">);</span>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>
<a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a><span class="p">}</span>
</code></pre></div>
<p>This class ingests the documents from the <code>rag.location</code> location into the vector store.
It runs when the application starts (thanks to the <a href="https://quarkus.io/guides/lifecycle#listening-for-startup-and-shutdown-events" target="_blank"><code>@Observes StartupEvent ev</code></a> parameter).</p>
<p>Additionally, it receives:</p>
<ul>
<li>the <code>PgVectorEmbeddingStore</code> bean to store the embeddings,</li>
<li>the <code>BgeSmallEnQuantizedEmbeddingModel</code> bean to generate the embeddings,</li>
<li>the <code>rag.location</code> configuration property to know where the documents are.</li>
</ul>
<p>The <code>FileSystemDocumentLoader.loadDocumentsRecursively(documents)</code> method loads the documents from the given location.</p>
<p>The <code>EmbeddingStoreIngestor</code> class is used to ingest the documents into the vector store.
This is the cornerstone of the ingestion process.
Configuring it correctly is crucial to the accuracy of the RAG pattern.
Here, we use a recursive document splitter with a segment size of 100 and an overlap size of 25 (like we had in the previous step).</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The splitter, the segment size, and the overlap size are crucial to the accuracy of the RAG pattern.
It depends on the documents you have and the use case you are working on.
There is no one-size-fits-all solution.
You may need to experiment with different configurations to find the best one for your use case.</p>
</div>
<p>Finally, we trigger the ingestion process and log a message when it’s done.</p>
<h2 id="the-retriever-and-augmentor">The retriever and augmentor<a class="headerlink" href="#the-retriever-and-augmentor" title="Permanent link"></a></h2>
<p>Now that we have our documents ingested into the vector store, we need to implement the retriever.
The retriever is responsible for finding the most relevant segments for a given query.
The augmentor is responsible for extending the prompt with the retrieved segments.</p>
<p><img alt="The augmentation process" src="../images/augmentation.png"></p>
<p><mark>Create the <code>dev.langchain4j.quarkus.workshop.RagRetriever</code> class with the following content:</mark></p>
<div class="highlight"><span class="filename">RagRetriever.java</span><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">dev.langchain4j.quarkus.workshop</span><span class="p">;</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.inject.Produces</span><span class="p">;</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.data.message.UserMessage</span><span class="p">;</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.model.embedding.EmbeddingModel</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.DefaultRetrievalAugmentor</span><span class="p">;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.RetrievalAugmentor</span><span class="p">;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.content.Content</span><span class="p">;</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.content.injector.ContentInjector</span><span class="p">;</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.content.retriever.EmbeddingStoreContentRetriever</span><span class="p">;</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.store.embedding.EmbeddingStore</span><span class="p">;</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RagRetriever</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">    </span><span class="nd">@Produces</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">    </span><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RetrievalAugmentor</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">EmbeddingStore</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">EmbeddingModel</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">contentRetriever</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EmbeddingStoreContentRetriever</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">                </span><span class="p">.</span><span class="na">embeddingModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">                </span><span class="p">.</span><span class="na">embeddingStore</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">                </span><span class="p">.</span><span class="na">maxResults</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DefaultRetrievalAugmentor</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="w">                </span><span class="p">.</span><span class="na">contentRetriever</span><span class="p">(</span><span class="n">contentRetriever</span><span class="p">)</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>create</code> method handles both the retrieval and the prompt augmentation.
It uses the <code>PgVectorEmbeddingStore</code> bean to retrieve the embeddings and the <code>BgeSmallEnQuantizedEmbeddingModel</code> bean to generate the embeddings.</p>
<div class="admonition important using the same embedding model">
<p class="admonition-title">Important</p>
<div class="highlight"><pre><span></span><code>It's crucial to use the same embedding model for the retriever and the ingestor.
Otherwise, the embeddings will not match, and the retriever will not find the relevant segments.
</code></pre></div>
</div>
<p>The <code>EmbeddingStoreContentRetriever</code> class is used to retrieve the most relevant segments.
We configure the maximum number of results to 3 (like in the previous step).
Remember that more results means a bigger prompt.
Not a problem here, but some LLMs have restrictions on the prompt (context) size.</p>
<p>The content retriever can also be configured with a filter (applied on the segment metadata), requires a minimum score, etc.</p>
<p>With this retriever, we can now build the prompt augmentation.
We create a <code>DefaultRetrievalAugmentor</code> with the content retriever.
It will:  </p>
<ol>
<li>Retrieve the most relevant segments for a given query (using the content retriever),</li>
<li>Augment the prompt with these segments.</li>
</ol>
<p>The augmentor has other options, like how the prompt is modified, how to use multiple retrievers, etc.
But let’s keep it simple for now.</p>
<h2 id="testing-the-application">Testing the application<a class="headerlink" href="#testing-the-application" title="Permanent link"></a></h2>
<p>Let’s see if everything works as expected.
<mark>If you stopped the application, restart it with the following command:</mark></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>./mvnw<span class="w"> </span>quarkus:dev
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Podman or Docker</p>
<p>The application requires Podman or Docker to automatically start a PostgreSQL database.
So make sure you have one of them installed and running.</p>
</div>
<p>When the application starts, it will ingest the documents into the vector store.</p>
<p>You can use the dev UI to verify the ingestion like we did in the previous step.
This time, let’s test with the chatbot instead:
<mark>Open your browser and go to <code>http://localhost:8080</code>.
Ask the question to the chatbot and see if it retrieves the relevant segments and builds a cohesive answer:</mark></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>What can you tell me about your cancellation policy?
</code></pre></div>
<h2 id="advanced-rag">Advanced RAG<a class="headerlink" href="#advanced-rag" title="Permanent link"></a></h2>
<p>In this step, we deconstructed the RAG pattern to understand how it works under the hood.
The RAG pattern is much more powerful than what we have seen here so far.</p>
<p>You can use different embedding models, different vector stores, different retrievers, etc.
The process can also be extended, especially the retrieval and the augmentation steps.</p>
<p><img alt="Advanced augmentation" src="../images/advanced-augmentation.png"></p>
<p>You can use multiple retrievers, filters, require a minimum score, etc.
When using multiple retrievers, you can combine the results, use the best one, etc.</p>
<p>Just to give an example, we are going to customize the content injector, i.e., how the segments are injected into the prompt.
Right now, you get something like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>&lt;user query&gt;
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>Answer using the following information:
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>&lt;segment 1&gt;
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>&lt;segment 2&gt;
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>&lt;segment 3&gt;
</code></pre></div>
<p>We are going to change it to:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>&lt;user query&gt;
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>Please, only use the following information:
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>- &lt;segment 1&gt;
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>- &lt;segment 2&gt;
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>- &lt;segment 3&gt;
</code></pre></div>
<p><mark>Edit the <code>create</code> method in the <code>RagRetriever</code> class to:</mark></p>
<div class="highlight"><span class="filename">RagRetriever.java</span><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">dev.langchain4j.quarkus.workshop</span><span class="p">;</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.inject.Produces</span><span class="p">;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.data.message.UserMessage</span><span class="p">;</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.model.embedding.EmbeddingModel</span><span class="p">;</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.DefaultRetrievalAugmentor</span><span class="p">;</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.RetrievalAugmentor</span><span class="p">;</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.content.Content</span><span class="p">;</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.content.injector.ContentInjector</span><span class="p">;</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.rag.content.retriever.EmbeddingStoreContentRetriever</span><span class="p">;</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.store.embedding.EmbeddingStore</span><span class="p">;</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RagRetriever</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">    </span><span class="nd">@Produces</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">    </span><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RetrievalAugmentor</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">EmbeddingStore</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">EmbeddingModel</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">contentRetriever</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EmbeddingStoreContentRetriever</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="w">                </span><span class="p">.</span><span class="na">embeddingModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">                </span><span class="p">.</span><span class="na">embeddingStore</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="w">                </span><span class="p">.</span><span class="na">maxResults</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DefaultRetrievalAugmentor</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="w">                </span><span class="p">.</span><span class="na">contentRetriever</span><span class="p">(</span><span class="n">contentRetriever</span><span class="p">)</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="hll"><span class="p">.</span><span class="na">contentInjector</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ContentInjector</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="hll"><span class="w">    </span><span class="nd">@Override</span>
</span><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="hll"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserMessage</span><span class="w"> </span><span class="nf">inject</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">UserMessage</span><span class="w"> </span><span class="n">userMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="hll"><span class="w">        </span><span class="n">StringBuffer</span><span class="w"> </span><span class="n">prompt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringBuffer</span><span class="p">(</span><span class="n">userMessage</span><span class="p">.</span><span class="na">singleText</span><span class="p">());</span>
</span><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="hll"><span class="w">        </span><span class="n">prompt</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">"\nPlease, only use the following information:\n"</span><span class="p">);</span>
</span><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="hll"><span class="w">        </span><span class="n">list</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">content</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">prompt</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">"- "</span><span class="p">).</span><span class="na">append</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="na">textSegment</span><span class="p">().</span><span class="na">text</span><span class="p">()).</span><span class="na">append</span><span class="p">(</span><span class="s">"\n"</span><span class="p">));</span>
</span><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserMessage</span><span class="p">(</span><span class="n">prompt</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
</span><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="hll"><span class="p">})</span>
</span><a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="p">}</span>
</code></pre></div>
<p>Now if you ask the question to the chatbot, you will get a different prompt. You can see this if you examine the latest logs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>INFO<span class="w">  </span><span class="o">[</span>io.qua.lan.ope.OpenAiRestApi<span class="nv">$OpenAiClientLogger</span><span class="o">]</span><span class="w"> </span><span class="o">(</span>vert.x-eventloop-thread-0<span class="o">)</span><span class="w"> </span>Request:
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>-<span class="w"> </span>method:<span class="w"> </span>POST
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>-<span class="w"> </span>url:<span class="w"> </span>https://api.openai.com/v1/chat/completions
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>-<span class="w"> </span>headers:<span class="w"> </span><span class="o">[</span>Accept:<span class="w"> </span>text/event-stream<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Authorization:<span class="w"> </span>Be...1f<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Content-Type:<span class="w"> </span>application/json<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>User-Agent:<span class="w"> </span>langchain4j-openai<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>content-length:<span class="w"> </span><span class="m">886</span><span class="o">]</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>-<span class="w"> </span>body:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">  </span><span class="s2">"model"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"gpt-4o"</span>,
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">  </span><span class="s2">"messages"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="s2">"role"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"system"</span>,
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="s2">"content"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"You are a customer support agent of a car rental company 'Miles of Smiles'.\nYou are friendly, polite and concise.\nIf the question is unrelated to car rental, you should politely redirect the customer to the right department.\n"</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">  </span><span class="o">}</span>,<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="s2">"role"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"user"</span>,
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="hll"><span class="w">    </span><span class="s2">"content"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"What can you tell me about your cancellation policy?\nPlease, only use the following information:\n- 4. Cancellation Policy\n- 4. Cancellation Policy 4.1 Reservations can be cancelled up to 11 days prior to the start of the\n- booking period.\n4.2 If the booking period is less than 4 days, cancellations are not permitted.\n"</span>
</span><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">  </span><span class="o">}</span><span class="w"> </span><span class="o">]</span>,
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">  </span><span class="s2">"temperature"</span><span class="w"> </span>:<span class="w"> </span><span class="m">0</span>.3,
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">  </span><span class="s2">"top_p"</span><span class="w"> </span>:<span class="w"> </span><span class="m">1</span>.0,
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="w">  </span><span class="s2">"stream"</span><span class="w"> </span>:<span class="w"> </span>true,
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="w">  </span><span class="s2">"stream_options"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">    </span><span class="s2">"include_usage"</span><span class="w"> </span>:<span class="w"> </span><span class="nb">true</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">  </span><span class="o">}</span>,
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="w">  </span><span class="s2">"max_tokens"</span><span class="w"> </span>:<span class="w"> </span><span class="m">1000</span>,
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="w">  </span><span class="s2">"presence_penalty"</span><span class="w"> </span>:<span class="w"> </span><span class="m">0</span>.0,
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="w">  </span><span class="s2">"frequency_penalty"</span><span class="w"> </span>:<span class="w"> </span><span class="m">0</span>.0
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="o">}</span>
</code></pre></div>
<p>This injector is a simple example.
It does not change the behavior of the RAG pattern.
But it shows you how you can customize the RAG pattern to fit your needs.</p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link"></a></h2>
<p>In this step, we deconstructed the RAG pattern to understand how it works under the hood.
We used our own embedding model and vector store.
We have seen the various aspects of the process and how you can customize them.</p>
<p>In the <a href="../step-07/">next step</a> let’s switch to another very popular pattern when using LLMs: Function Calls and Tools.</p></div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../step-05/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Step 5 - Introduction to the RAG pattern">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Step 5 - Introduction to the RAG pattern
              </div>
            </div>
          </a>
        
        
          
          <a href="../step-07/" class="md-footer__link md-footer__link--next" aria-label="Next: Step 7 - Function calling and tools">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Step 7 - Function calling and tools
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!--
  Copyright (c) 2016-2022 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Copyright and theme information, adapter to have the Red Hat footer -->
<div class="md-copyright">
    <div class="md-copyright__highlight">
        Sponsored by <a href="https://www.redhat.com"><img style="vertical-align: middle;" alt="Red Hat" src="../images/redhat_reversed.svg"/></a> <br/>
        <a href="https://creativecommons.org/licenses/by/3.0/">CC by 3.0</a> |
        <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </div>
    
    Made with
    <a
            href="https://squidfunk.github.io/mkdocs-material/"
            target="_blank" rel="noopener"
    >
        Material for MkDocs
    </a>
    
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "content.tabs.link", "content.code.annotate", "navigation.instant", "navigation.indexes", "navigation.tracking", "navigation.footer", "navigation.tabs.sticky", "content.code.select", "content.code.copy"], "search": "../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.56dfad97.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>